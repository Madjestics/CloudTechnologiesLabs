<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Movie Watch Tester — без авторизации</title>
    <style>
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 24px; background:#f7fafc; color:#0f172a }
        .card{ background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(12,16,24,0.06); max-width:1000px; margin:0 auto }
        label{ display:block; margin-bottom:8px; font-weight:600 }
        input[type="text"]{ padding:8px 10px; width:260px; border-radius:8px; border:1px solid #e2e8f0 }
        button{ margin-left:8px; padding:8px 12px; border-radius:8px; border:none; background:#2563eb; color:white; cursor:pointer }
        button.secondary{ background:#94a3b8 }
        .row{ display:flex; align-items:center; gap:8px; margin-bottom:12px }
        video{ width:100%; max-height:65vh; background:#000; border-radius:8px }
        pre{ background:#0b1220; color:#d1d5db; padding:12px; border-radius:8px; overflow:auto }
        .meta{ margin-top:12px; font-size:13px; color:#475569 }
    </style>
</head>
<body>
<div class="card">
    <h2>Тест страницы для просмотра видео</h2>
    <p class="meta">Укажите ID фильма</p>

    <div class="row">
        <label for="movieId">Movie ID</label>
        <input id="movieId" type="text" value="2" />
        <button id="playBtn">Play</button>
        <button id="openTabBtn" class="secondary">Open in new tab</button>
        <button id="checkRangeBtn" class="secondary">Check Range support</button>
    </div>

    <video id="player" controls crossorigin="anonymous">
        <p>Ваш браузер не поддерживает элемент <code>&lt;video&gt;</code>.</p>
    </video>

    <h3>Результат проверки</h3>
    <pre id="out">Готово. Введите ID и нажмите Play.</pre>
</div>

<script>
    const player = document.getElementById('player');
    const playBtn = document.getElementById('playBtn');
    const openTabBtn = document.getElementById('openTabBtn');
    const checkRangeBtn = document.getElementById('checkRangeBtn');
    const out = document.getElementById('out');
    const movieIdInput = document.getElementById('movieId');

    function apiUrl(id) {
        // при необходимости поменяйте путь
        return `/api/movie/watch/${encodeURIComponent(id)}`;
    }

    playBtn.addEventListener('click', async () => {
        const id = movieIdInput.value.trim();
        if (!id) return alert('Введите id');
        const url = apiUrl(id);
        player.src = url;
        player.load();
        try { await player.play(); out.textContent = `Воспроизведение: ${url}`; }
        catch(e){ out.textContent = `Ошибка при попытке play(): ${e}` }
    });

    openTabBtn.addEventListener('click', () => {
        const id = movieIdInput.value.trim();
        if (!id) return alert('Введите id');
        window.open(apiUrl(id), '_blank');
    });

    checkRangeBtn.addEventListener('click', async () => {
        const id = movieIdInput.value.trim();
        if (!id) return alert('Введите id');
        const url = apiUrl(id);
        out.textContent = `Проверка ${url} ...`;

        // 1) Пробуем HEAD
        try {
            const headResp = await fetch(url, { method: 'HEAD' });
            out.textContent = `HEAD -> ${headResp.status} ${headResp.statusText}\n` +
                Array.from(headResp.headers.entries()).map(h => h.join(': ')).join('\n');
        } catch (err) {
            out.textContent = `HEAD запрос завершился ошибкой: ${err}\n`;
        }

        // 2) Пробуем GET с Range: bytes=0-0
        try {
            const rangeResp = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' } });
            out.textContent += '\n\nGET (Range: bytes=0-0) -> ' + rangeResp.status + ' ' + rangeResp.statusText + '\n'
                + Array.from(rangeResp.headers.entries()).map(h => h.join(': ')).join('\n');

            // прочитаем кусочек тела (необязательно)
            const chunk = await rangeResp.arrayBuffer();
            out.textContent += '\n\nRead bytes: ' + chunk.byteLength;
        } catch (err) {
            out.textContent += '\n\nGET с Range завершился ошибкой: ' + err;
        }
    });
</script>
</body>
</html>
